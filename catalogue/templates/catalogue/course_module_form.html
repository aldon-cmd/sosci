{% extends "base.html" %}
{% load static widget_tweaks %}

{% block styles %}

{{block.super}}
<style>
  .progress {
  height: 32px;
}
</style>
{% endblock styles %}
{% block content %}
<main id="course-detail-module">
  <div class="container ss-relative">
    <div class="box">
      <div>
        <h3 class="subheading">Course Title</h3>
        <div class="box-border">
          <p class="settings-row">{{ course.title }}</p>
        </div>
      </div>
      <div>     
        <h3 class="subheading">Course Description</h3>
        <div class="box-border">
          <p class="settings-row">{{ course.description }}</p>
        </div>
      </div>
      <div>
        <div class="form-group text-right">
          <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#module-modal">
            Add
          </button>
        </div>
        {% for module in modules %}
        <h3 class="subheading">{{ module.name }}</h3>
        <div class="box-border">
          <p class="settings-row">{{ module.duration }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</main>


<!-- Modal -->
<div class="modal fade" id="module-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

		<form id="course-module-form" class="text-truncate">

		  <div class="p-2 bg-dark text-white font-weight-bold">Course Module</div>
		  <div class="form-group">         <div class="col">{% include 'partials/form_field.html' with field=form.name %}</div>
		</div>
		<div class="form-group">         <div class="col">{% include 'partials/form_field.html' with field=form.duration %}</div>
		</div>
				  <div class="form-group">         <div class="col">{% include 'partials/form_field.html' with field=form.chunksize|append_attr:"id:chunksize" %}</div>
		</div>
		<div class="form-group">         <div class="col">{% include 'partials/form_field.html' with field=form.video_file %}</div>
		</div>

        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-success">
            <span class="bar" style="width: 0%;"></span>
          </div>
        </div>
		<div class="form-group">
		  <button type="button" class="btn btn-danger stop" id="toggle-btn">
		    upload
		  </button>
		</div>
	
		</form>

      <hr />
      <h3>Uploads</h3>
      <p id="upload-list">
        Succesful uploads will be listed here. Try one!
      </p>

      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
</div>
{% endblock content %}

{% block extrascripts %}
{{ block.super }}

<script src="{% static 'js/tus.js' %}"></script>
<script>
var upload          = null;
var uploadIsRunning = false;
var toggleBtn       = document.querySelector("#toggle-btn");
var resumeCheckbox  = document.querySelector("#resume");
var video_file_input = $("input[name=video_file]");
var progress        = document.querySelector(".progress-bar");
var progressBar     = progress.querySelector(".bar");
var alertBox        = document.querySelector("#support-alert");
var uploadList      = document.querySelector("#upload-list");
var chunkInput      = document.querySelector("#chunksize");
var endpointInput   = document.querySelector("#endpoint");

if (!tus.isSupported) {
  alertBox.classList.remove("hidden");
}

if (!toggleBtn) {
  throw new Error("Toggle button not found on this page. Aborting upload-demo. ");
}

toggleBtn.addEventListener("click", function (e) {
  e.preventDefault();

  create_video();
});

function create_video(){
    var file = video_file_input.prop("files")[0];
    var course_module_form_data = {}; 
    $("#course-module-form").serializeArray().forEach(function(x){course_module_form_data[x.name] = x.value;});

    $.ajax({
      url: "{% url 'video:video-upload-attempt' view.kwargs.course_id %}",
      method: "POST",
      dataType: "json",
      data: {
      		  name: course_module_form_data.name,
      		  duration: course_module_form_data.duration,
              file_size: file.size,
              csrfmiddlewaretoken: '{{ csrf_token }}'
            }
  }).done(function(data, textStatus, jqXHR){

    if (upload) {
      if (uploadIsRunning) {
        upload.abort();
        toggleBtn.textContent = "resume upload";
        uploadIsRunning = false;
      } else {
        upload.start();
        toggleBtn.textContent = "pause upload";
        uploadIsRunning = true;
      }
    } else {
      if (video_file_input.prop("files").length > 0) {
        start_upload(data.upload.upload_link);
      } else {
        video_file_input.click();
      }
    }

    
  });
}

function start_upload(upload_link) {
  var file = video_file_input.prop("files")[0];
  // Only continue if a file has actually been selected.
  // IE will trigger a change event even if we reset the input element
  // using reset() and we do not want to blow up later.
  if (!file) {
    return;
  }

  var chunkSize = parseInt(chunkInput.value, 10);
  if (isNaN(chunkSize)) {
    chunkSize = Infinity;
  }

  toggleBtn.textContent = "pause upload";

  var options = {
    endpoint: upload_link,
    uploadUrl: upload_link,
    resume  : true,
    uploadSize: file.size,
    chunkSize: chunkSize,
    retryDelays: [0, 1000, 3000, 5000],
    metadata: {
      filename: file.name,
      filetype: file.type
    },
    onError : function (error) {
      if (error.originalRequest) {
        if (window.confirm("Failed because: " + error + "\nDo you want to retry?")) {
          upload.start();
          uploadIsRunning = true;
          return;
        }
      } else {
        window.alert("Failed because: " + error);
      }

      reset();
    },
    onProgress: function (bytesUploaded, bytesTotal) {
      var percentage = (bytesUploaded / bytesTotal * 100).toFixed(2);
      progressBar.style.width = percentage + "%";
      console.log(bytesUploaded, bytesTotal, percentage + "%");
    },
    onSuccess: function () {
      var anchor = document.createElement("a");
      anchor.textContent = "Download " + upload.file.name + " (" + upload.file.size + " bytes)";
      anchor.href = upload.url;
      anchor.className = "btn btn-success";
      uploadList.appendChild(anchor);

      reset();
      location.reload();
    }
  };

  upload = new tus.Upload(file, options);
  upload.start();
  uploadIsRunning = true;
}

function reset() {
  video_file_input.value = "";
  toggleBtn.textContent = "start upload";
  upload = null;
  uploadIsRunning = false;
}  
</script>


{% endblock extrascripts %}
